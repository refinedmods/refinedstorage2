name: Build
on:
    push:
    pull_request:
        types: [ opened, synchronize, reopened ]
jobs:
    build:
        strategy:
            matrix:
                java: [
                        17
                ]
                os: [ ubuntu-latest ]
        runs-on: ${{ matrix.os }}
        steps:
            -   name: Checkout repository
                uses: actions/checkout@v2
                with:
                    fetch-depth: 0  # Shallow clones should be disabled for a better relevancy of analysis
            -   name: Validate Gradle wrapper
                uses: gradle/wrapper-validation-action@v1
            -   name: Setup JDK ${{ matrix.java }}
                uses: actions/setup-java@v1
                with:
                    java-version: ${{ matrix.java }}
            # https://docs.sonarqube.org/latest/analysis/github-integration/
            -   name: Cache SonarQube packages
                uses: actions/cache@v1
                with:
                    path: ~/.sonar/cache
                    key: ${{ runner.os }}-sonar
                    restore-keys: ${{ runner.os }}-sonar
            -   name: Cache Gradle packages
                uses: actions/cache@v1
                with:
                    path: ~/.gradle/caches
                    key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle') }}
                    restore-keys: ${{ runner.os }}-gradle
            -   name: Make Gradle wrapper executable
                if: ${{ runner.os != 'Windows' }}
                run: chmod +x ./gradlew
            -   name: Build, test and analyze
                if: ${{ github.event.pull_request.head.repo.fork }}
                run: ./gradlew build pitest codeCoverageReport
                env:
                    GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                    SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
            # TODO: We have to disable Sonar for now on forked PR builds as the analyze fails due to permission issues.
            -   name: Build, test and analyze (including SonarQube)
                if: ${{ !github.event.pull_request.head.repo.fork }}
                run: ./gradlew build pitest codeCoverageReport sonarqube
                env:
                    GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                    SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
            -   name: Publish test report
                uses: mikepenz/action-junit-report@v3
                if: always() # always run even if the previous step fails
                with:
                    report_paths: '**/build/test-results/test/TEST-*.xml'
            -   name: Checkstyle
                run: ./gradlew checkstyleMain checkstyleTest
            -   name: Upload build artifacts
                if: ${{ runner.os == 'Linux' && matrix.java == '17' }}
                uses: actions/upload-artifact@v2
                with:
                    name: Artifacts
                    path: refinedstorage2-*/build/libs/
